name: Build Custom Linux Distro

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y debootstrap genisoimage squashfs-tools xorriso mtools grub-pc-bin grub-efi-amd64-bin

    - name: Create Root Filesystem
      run: |
        mkdir -p custom_distro/chroot
        sudo debootstrap --arch=amd64 focal custom_distro/chroot http://archive.ubuntu.com/ubuntu/
        sudo mount --bind /dev custom_distro/chroot/dev
        sudo mount --bind /proc custom_distro/chroot/proc
        sudo mount --bind /sys custom_distro/chroot/sys

    - name: Configure the Chroot Environment
      run: |
        sudo cp /etc/resolv.conf custom_distro/chroot/etc/
        sudo chroot custom_distro/chroot /bin/bash -c "
          apt-get update &&
          apt-get install -y ubuntu-desktop gnome-shell gdm3 &&
          apt-get install -y python3 python3-tk google-chrome-stable &&
          echo 'python3 /hello_world.py' >> /etc/rc.local &&
          chmod +x /etc/rc.local
        "

    - name: Add Custom Python Script
      run: |
        echo 'import tkinter as tk' > custom_distro/chroot/hello_world.py
        echo 'root = tk.Tk()' >> custom_distro/chroot/hello_world.py
        echo 'root.geometry("600x400")' >> custom_distro/chroot/hello_world.py
        echo 'label = tk.Label(root, text="Hello, World!")' >> custom_distro/chroot/hello_world.py
        echo 'label.pack(pady=20)' >> custom_distro/chroot/hello_world.py
        echo 'root.mainloop()' >> custom_distro/chroot/hello_world.py

    - name: Configure GRUB
      run: |
        sudo chroot custom_distro/chroot /bin/bash -c "
          apt-get install -y grub-efi-amd64
          grub-install --target=i386-pc --boot-directory=/boot /dev/loop0
          grub-mkconfig -o /boot/grub/grub.cfg
        "

    - name: Create ISO Image
      run: |
        mkdir -p custom_distro/iso/boot/grub
        sudo cp custom_distro/chroot/boot/grub/grub.cfg custom_distro/iso/boot/grub/grub.cfg
        sudo cp -r custom_distro/chroot/* custom_distro/iso/
        sudo genisoimage -o custom_linux.iso -b boot/grub/i386-pc/eltorito.img \
          -no-emul-boot -boot-load-size 4 -boot-info-table -J -R -V "Custom Linux" \
          custom_distro/iso

    - name: Upload ISO as Artifact
      uses: actions/upload-artifact@v2
      with:
        name: custom-linux-iso
        path: custom_linux.iso
